#!/bin/bash
#
# Pre-commit hook to check for vulnerabilities in Python dependencies
# Install: ln -s ../../scripts/pre_commit_vulnerability_check.sh .git/hooks/pre-commit
#

set -e

echo "üîç Checking for dependency vulnerabilities..."

# Check if requirements files were modified
REQUIREMENTS_MODIFIED=$(git diff --cached --name-only | grep -E 'requirements\.txt$' || true)

if [ -z "$REQUIREMENTS_MODIFIED" ]; then
    echo "‚úÖ No requirements.txt files modified, skipping vulnerability check"
    exit 0
fi

echo "üì¶ Modified requirements files:"
echo "$REQUIREMENTS_MODIFIED"

# Check if pip-audit is installed
if ! python3 -c "import pip_audit" 2>/dev/null; then
    echo "‚ö†Ô∏è  pip-audit not installed. Installing..."
    pip3 install pip-audit
fi

# Track if any vulnerabilities found
VULNERABILITIES_FOUND=0

# Scan each modified requirements file
while IFS= read -r req_file; do
    if [ -f "$req_file" ]; then
        echo ""
        echo "Scanning $req_file..."

        # Run pip-audit
        if ! python3 -m pip_audit -r "$req_file" --desc 2>&1; then
            VULNERABILITIES_FOUND=1
            echo "‚ùå Vulnerabilities found in $req_file"
        else
            echo "‚úÖ $req_file is clean"
        fi
    fi
done <<< "$REQUIREMENTS_MODIFIED"

if [ $VULNERABILITIES_FOUND -eq 1 ]; then
    echo ""
    echo "=========================================="
    echo "‚ùå COMMIT BLOCKED: Vulnerabilities detected!"
    echo "=========================================="
    echo ""
    echo "Please fix the vulnerabilities before committing:"
    echo "1. Update packages to secure versions"
    echo "2. Run: python3 scripts/vulnerability_scan.py"
    echo "3. Retry your commit"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
fi

echo ""
echo "‚úÖ All dependencies are secure!"
exit 0
