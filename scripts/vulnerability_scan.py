#!/usr/bin/env python3
"""
Vulnerability Scanner for Autograph Dependencies
Scans all Python services for known security vulnerabilities
"""

import subprocess
import json
import sys
from pathlib import Path
from typing import Dict, List, Any


class VulnerabilityScanner:
    def __init__(self, project_root: Path):
        self.project_root = project_root
        self.services_dir = project_root / "services"
        self.results = {}

    def scan_service(self, service_name: str) -> Dict[str, Any]:
        """Scan a single service for vulnerabilities"""
        requirements_file = self.services_dir / service_name / "requirements.txt"

        if not requirements_file.exists():
            return {
                "service": service_name,
                "status": "error",
                "message": f"No requirements.txt found",
                "vulnerabilities": []
            }

        print(f"Scanning {service_name}...", file=sys.stderr)

        try:
            # Run pip-audit with JSON output
            result = subprocess.run(
                [sys.executable, "-m", "pip_audit", "-r", str(requirements_file), "--format", "json"],
                capture_output=True,
                text=True,
                timeout=60
            )

            if result.returncode == 0:
                # No vulnerabilities found
                return {
                    "service": service_name,
                    "status": "clean",
                    "vulnerabilities": []
                }
            else:
                # Parse JSON output with vulnerabilities
                try:
                    data = json.loads(result.stdout)
                    vulnerabilities = data.get("vulnerabilities", [])

                    return {
                        "service": service_name,
                        "status": "vulnerable" if vulnerabilities else "clean",
                        "vulnerabilities": vulnerabilities,
                        "count": len(vulnerabilities)
                    }
                except json.JSONDecodeError:
                    return {
                        "service": service_name,
                        "status": "error",
                        "message": "Failed to parse scan results",
                        "vulnerabilities": []
                    }

        except subprocess.TimeoutExpired:
            return {
                "service": service_name,
                "status": "error",
                "message": "Scan timeout",
                "vulnerabilities": []
            }
        except Exception as e:
            return {
                "service": service_name,
                "status": "error",
                "message": str(e),
                "vulnerabilities": []
            }

    def scan_all_services(self) -> Dict[str, Any]:
        """Scan all services in the project"""
        services = [
            "auth-service",
            "api-gateway",
            "diagram-service",
            "collaboration-service",
            "ai-service",
            "export-service",
            "git-service",
            "integration-hub"
        ]

        results = {}
        for service_name in services:
            results[service_name] = self.scan_service(service_name)

        return results

    def generate_report(self, results: Dict[str, Any]) -> Dict[str, Any]:
        """Generate a summary report"""
        total_services = len(results)
        clean_services = sum(1 for r in results.values() if r.get("status") == "clean")
        vulnerable_services = sum(1 for r in results.values() if r.get("status") == "vulnerable")
        error_services = sum(1 for r in results.values() if r.get("status") == "error")

        total_vulnerabilities = sum(r.get("count", 0) for r in results.values())

        # Categorize vulnerabilities by severity
        critical_vulns = []
        high_vulns = []
        medium_vulns = []
        low_vulns = []

        for service_name, result in results.items():
            for vuln in result.get("vulnerabilities", []):
                vuln_info = {
                    "service": service_name,
                    "package": vuln.get("name"),
                    "version": vuln.get("version"),
                    "id": vuln.get("id"),
                    "fix_versions": vuln.get("fix_versions", [])
                }

                # Categorize by CVE ID or severity indicators
                vuln_id = vuln.get("id", "").upper()
                if "CRITICAL" in vuln_id or any(cve in vuln_id for cve in ["CVE-2024-12", "CVE-2025"]):
                    critical_vulns.append(vuln_info)
                elif "HIGH" in vuln_id:
                    high_vulns.append(vuln_info)
                elif "MEDIUM" in vuln_id or "MODERATE" in vuln_id:
                    medium_vulns.append(vuln_info)
                else:
                    # Check if it has DoS or RCE keywords
                    desc = vuln.get("description", "").upper()
                    if "DENIAL OF SERVICE" in desc or "REMOTE CODE" in desc:
                        high_vulns.append(vuln_info)
                    else:
                        medium_vulns.append(vuln_info)

        return {
            "summary": {
                "total_services": total_services,
                "clean_services": clean_services,
                "vulnerable_services": vulnerable_services,
                "error_services": error_services,
                "total_vulnerabilities": total_vulnerabilities,
                "critical_count": len(critical_vulns),
                "high_count": len(high_vulns),
                "medium_count": len(medium_vulns),
                "low_count": len(low_vulns)
            },
            "critical_vulnerabilities": critical_vulns,
            "high_vulnerabilities": high_vulns,
            "medium_vulnerabilities": medium_vulns,
            "low_vulnerabilities": low_vulns,
            "service_results": results
        }

    def print_report(self, report: Dict[str, Any]):
        """Print human-readable report"""
        summary = report["summary"]

        print("\n" + "="*80)
        print("VULNERABILITY SCAN REPORT")
        print("="*80)

        print(f"\nServices Scanned: {summary['total_services']}")
        print(f"  âœ… Clean: {summary['clean_services']}")
        print(f"  âš ï¸  Vulnerable: {summary['vulnerable_services']}")
        print(f"  âŒ Errors: {summary['error_services']}")

        print(f"\nTotal Vulnerabilities: {summary['total_vulnerabilities']}")
        print(f"  ðŸ”´ Critical: {summary['critical_count']}")
        print(f"  ðŸŸ  High: {summary['high_count']}")
        print(f"  ðŸŸ¡ Medium: {summary['medium_count']}")
        print(f"  ðŸŸ¢ Low: {summary['low_count']}")

        if summary['critical_count'] > 0:
            print("\n" + "="*80)
            print("CRITICAL VULNERABILITIES (Must Fix Immediately)")
            print("="*80)
            for vuln in report['critical_vulnerabilities']:
                print(f"\nðŸ”´ {vuln['service']}: {vuln['package']} {vuln['version']}")
                print(f"   ID: {vuln['id']}")
                print(f"   Fix: {', '.join(vuln['fix_versions']) if vuln['fix_versions'] else 'No fix available'}")

        if summary['high_count'] > 0:
            print("\n" + "="*80)
            print("HIGH SEVERITY VULNERABILITIES")
            print("="*80)
            for vuln in report['high_vulnerabilities']:
                print(f"\nðŸŸ  {vuln['service']}: {vuln['package']} {vuln['version']}")
                print(f"   ID: {vuln['id']}")
                print(f"   Fix: {', '.join(vuln['fix_versions']) if vuln['fix_versions'] else 'No fix available'}")

        print("\n" + "="*80)
        print("RECOMMENDATIONS")
        print("="*80)

        if summary['total_vulnerabilities'] == 0:
            print("âœ… All dependencies are up to date with no known vulnerabilities!")
        else:
            print(f"âš ï¸  Found {summary['total_vulnerabilities']} vulnerabilities across {summary['vulnerable_services']} services")
            print("\nNext steps:")
            print("1. Review and update vulnerable packages to fixed versions")
            print("2. Test services after updates")
            print("3. Re-run vulnerability scan to verify fixes")
            if summary['critical_count'] > 0:
                print(f"\nâŒ CRITICAL: {summary['critical_count']} critical vulnerabilities must be fixed immediately!")
                sys.exit(1)


def main():
    project_root = Path(__file__).parent.parent
    scanner = VulnerabilityScanner(project_root)

    # Scan all services
    results = scanner.scan_all_services()

    # Generate and print report
    report = scanner.generate_report(results)
    scanner.print_report(report)

    # Save detailed results to JSON
    output_file = project_root / "vulnerability_scan_results.json"
    with open(output_file, 'w') as f:
        json.dump(report, f, indent=2)

    print(f"\nðŸ“„ Detailed results saved to: {output_file}")

    # Exit with appropriate code
    if report['summary']['critical_count'] > 0:
        sys.exit(1)  # Fail on critical vulnerabilities
    elif report['summary']['total_vulnerabilities'] > 0:
        sys.exit(2)  # Warning on any vulnerabilities
    else:
        sys.exit(0)  # Success


if __name__ == "__main__":
    main()
