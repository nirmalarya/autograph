events {
    worker_connections 1024;
}

http {
    # Define upstream servers for load balancing
    
    # Diagram service - round-robin load balancing
    upstream diagram_service_backend {
        # Round-robin by default
        server diagram-service-1:8082 max_fails=3 fail_timeout=30s;
        server diagram-service-2:8082 max_fails=3 fail_timeout=30s;
        server diagram-service-3:8082 max_fails=3 fail_timeout=30s;
        
        # Health check parameters
        keepalive 32;
    }
    
    # Collaboration service - sticky sessions for WebSocket
    upstream collaboration_service_backend {
        # IP hash for sticky sessions (important for WebSocket)
        ip_hash;
        
        server collaboration-service-1:8083 max_fails=3 fail_timeout=30s;
        server collaboration-service-2:8083 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # AI service - least connections for CPU-intensive tasks
    upstream ai_service_backend {
        # Least connections for better load distribution
        least_conn;
        
        server ai-service-1:8084 max_fails=3 fail_timeout=30s;
        server ai-service-2:8084 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # Auth service - round-robin
    upstream auth_service_backend {
        server auth-service-1:8085 max_fails=3 fail_timeout=30s;
        server auth-service-2:8085 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # Export service - round-robin
    upstream export_service_backend {
        server export-service-1:8097 max_fails=3 fail_timeout=30s;
        server export-service-2:8097 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # Git service - round-robin
    upstream git_service_backend {
        server git-service-1:8087 max_fails=3 fail_timeout=30s;
        server git-service-2:8087 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # Integration hub - round-robin
    upstream integration_hub_backend {
        server integration-hub-1:8099 max_fails=3 fail_timeout=30s;
        server integration-hub-2:8099 max_fails=3 fail_timeout=30s;
        
        keepalive 32;
    }
    
    # Logging
    log_format upstreamlog '[$time_local] $remote_addr - $server_name to: $upstream_addr: $request upstream_response_time $upstream_response_time msec $msec request_time $request_time';
    access_log /var/log/nginx/access.log upstreamlog;
    error_log /var/log/nginx/error.log warn;
    
    # Load balancer server
    server {
        listen 8090;
        server_name _;
        
        # Health check endpoint
        location /lb-health {
            access_log off;
            return 200 "Load balancer healthy\n";
            add_header Content-Type text/plain;
        }
        
        # Diagram service
        location /diagrams {
            proxy_pass http://diagram_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # Health checks via headers
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # Collaboration service (WebSocket support)
        location /collaboration {
            proxy_pass http://collaboration_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Longer timeouts for WebSocket
            proxy_connect_timeout 300s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # AI service
        location /ai {
            proxy_pass http://ai_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Longer timeout for AI processing
            proxy_connect_timeout 120s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
            
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # Auth service
        location /auth {
            proxy_pass http://auth_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # Export service
        location /export {
            proxy_pass http://export_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Longer timeout for exports
            proxy_connect_timeout 90s;
            proxy_send_timeout 90s;
            proxy_read_timeout 90s;
            
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # Git service
        location /git {
            proxy_pass http://git_service_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # Integration hub
        location /integrations {
            proxy_pass http://integration_hub_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # Status page
        location /lb-status {
            stub_status on;
            access_log off;
        }
    }
}
